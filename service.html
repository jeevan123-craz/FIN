<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš¨ SOS, Medicine & Meal Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #1976D2;
      --danger: #D32F2F;
      --success: #388E3C;
      --bg: #f9f9f9;
      --card: #fff;
      --text: #333;
    }
    body.dark { --bg: #121212; --card: #1e1e1e; --text: #eee; }
    body {
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      margin: 0;
      transition: 0.4s;
    }
    .container { max-width: 700px; margin: auto; }
    h2 { border-bottom: 2px solid var(--primary); padding-bottom: 5px; }
    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .sos-btn { display: block; width: 100%; background-color: var(--danger); color: #fff; font-size: 32px; padding: 20px 0; border: none; border-radius: 40px; cursor: pointer; transition: 0.3s; }
    .sos-btn:hover { opacity: 0.85; }
    input, button, select { font-size: 16px; padding: 10px; margin-top: 8px; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background-color: var(--primary); color: white; border: none; cursor: pointer; }
    button:hover { opacity: 0.9; }
    .med-item, .meal-item { display: flex; justify-content: space-between; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin: 5px 0; align-items: center; }
    #clock { text-align: center; font-size: 18px; margin-bottom: 20px; }
    .toggle { background: var(--success); }
    .toggle.off { background: #fbc02d; color: #000; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .done { text-decoration: line-through; color: gray; }
    #gcalStatus { font-size: 14px; text-align: center; color: var(--success); }
    .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 10px 16px; border-radius: 8px; opacity: 0.9; z-index: 1000; animation: fadeInOut 3s forwards; }
    .toast.success { background: #388E3C; }
    .toast.error { background: #D32F2F; }
    @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(20px); } 10%,90% { opacity: 0.9; transform: translateY(0); } 100% { opacity: 0; transform: translateY(20px); }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-bar">
      <h1>ğŸ©º Health & Safety Hub</h1>
      <button onclick="toggleDarkMode()">ğŸŒ—</button>
    </div>
    <p id="clock"></p>

    <!-- Google Calendar Connect -->
    <button id="googleConnectBtn" onclick="handleGoogleLogin()">ğŸ”‘ Connect Google Calendar</button>
    <p id="gcalStatus"></p>

    <!-- SOS Button -->
    <button class="sos-btn" onclick="sendSOS()">ğŸš¨ SEND SOS</button>

    <!-- Call Button -->
    <div class="card" style="text-align:center;">
      <h2>ğŸ“ Emergency Call</h2>
      <p>Tap below to instantly call your emergency number.</p>
      <a href="tel:9442983888">
        <button style="background:#D32F2F; font-size:20px;">ğŸ“ Call 9442983888</button>
      </a>
    </div>

    <!-- Medicine Section -->
    <div class="card">
      <h2>ğŸ’Š Medicine Tracker</h2>
      <form id="medForm" onsubmit="event.preventDefault(); addMedicine();">
        <input type="text" id="medName" placeholder="Medicine name" required />
        <input type="time" id="medTime" required />
        <button type="submit">Add Medicine (Also adds to Google Calendar)</button>
      </form>
      <div id="medList"></div>
      <button class="toggle" id="alarmToggle" onclick="toggleAlarm()">Alarm ON</button>
      <button onclick="exportMedicinesToPDF()">ğŸ“„ Export Medicines</button>
    </div>

    <!-- Meal Section -->
    <div class="card">
      <h2>ğŸ½ï¸ Meal Scheduler</h2>
      <label>Breakfast: <input type="time" id="breakfastTime" /></label><br />
      <label>Lunch: <input type="time" id="lunchTime" /></label><br />
      <label>Dinner: <input type="time" id="dinnerTime" /></label><br />
      <button onclick="addMealTimesToCalendar()">Add Meals to Google Calendar</button>
    </div>

    <!-- Weekly Graph -->
    <div class="card">
      <h2>ğŸ“ˆ Weekly Health Summary</h2>
      <canvas id="weeklyChart" height="200"></canvas>
    </div>

    <!-- Health Report -->
    <div class="card">
      <h2>ğŸ“Š Daily Health Report</h2>
      <div id="reportTableContainer"></div>
      <button onclick="exportHealthReport()">ğŸ“„ Export Health Report</button>
    </div>
  </div>

  <div class="fab" onclick="scrollToMed()">â•</div>

  <!-- External Libraries -->
  <script src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <script>
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");
    let medicines = [];
    let meals = [];
    let healthReport = {};
    let isGoogleConnected = false;

    // Clock
    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleString(); }, 1000);

    window.onload = () => {
      handleClientLoad();
      medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
      healthReport = JSON.parse(localStorage.getItem("healthReport") || "{}");
      renderMedicines();
      drawWeeklyChart();
    };

    // Toast
    function showToast(msg, type="success"){ const t=document.createElement("div"); t.className=`toast ${type}`; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
    function toggleDarkMode(){ document.body.classList.toggle("dark"); showToast("ğŸŒ— Theme toggled"); }

    // Medicine
    function addMedicine(){
      const name=medName.value.trim(); const time=medTime.value;
      if(!name||!time) return showToast("Fill all fields","error");
      medicines.push({name,time}); localStorage.setItem("medicines",JSON.stringify(medicines));
      renderMedicines();
      const today=new Date(); const [h,m]=time.split(":");
      const start=new Date(today.getFullYear(),today.getMonth(),today.getDate(),+h,+m);
      const end=new Date(start.getTime()+15*60000);
      createCalendarEvent(start.toISOString(),end.toISOString(),`ğŸ’Š Take ${name}`);
      showToast("âœ… Medicine added!"); medName.value=medTime.value="";
    }
    function deleteMedicine(i){ medicines.splice(i,1); localStorage.setItem("medicines",JSON.stringify(medicines)); renderMedicines(); showToast("ğŸ—‘ï¸ Medicine deleted"); }
    function renderMedicines(){ medList.innerHTML = medicines.length ? "" : "<p>No medicines added.</p>";
      medicines.forEach((m,i)=>{ medList.innerHTML+=`<div class='med-item'><span>ğŸ’Š <b>${m.name}</b> at ${m.time}</span><button onclick="deleteMedicine(${i})">ğŸ—‘ï¸</button></div>`; });
    }
    function scrollToMed(){ document.getElementById("medForm").scrollIntoView({behavior:"smooth"}); }

    // Google Calendar
    const CLIENT_ID="749237950089-f7gpgjh22mglc3827s5qa1s433vm6feu.apps.googleusercontent.com";
    const API_KEY="AIzaSyCYiPB9Er-M0CW4R9ApT3R7Tod3yccKC_A";
    const DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
    const SCOPES="https://www.googleapis.com/auth/calendar.events";

    function handleClientLoad(){ gapi.load("client:auth2", initClient); }
    function initClient(){
      gapi.client.init({apiKey:API_KEY, clientId:CLIENT_ID, discoveryDocs:DISCOVERY_DOCS, scope:SCOPES}).then(()=>{
        const auth=gapi.auth2.getAuthInstance();
        auth.isSignedIn.listen(updateGCalStatus);
        updateGCalStatus(auth.isSignedIn.get());
      });
    }
    function handleGoogleLogin(){ gapi.auth2.getAuthInstance().signIn(); }
    function updateGCalStatus(signedIn){
      googleConnectBtn.style.display=signedIn?"none":"block";
      gcalStatus.textContent=signedIn?"âœ… Connected to Google Calendar":"âŒ Not connected";
      isGoogleConnected=signedIn;
    }
    function createCalendarEvent(start,end,title){
      if(!isGoogleConnected)return;
      gapi.client.calendar.events.insert({calendarId:"primary",resource:{summary:title,start:{dateTime:start},end:{dateTime:end}}});
    }

    // SOS
    function sendSOS(){
      navigator.geolocation.getCurrentPosition(pos=>{
        const loc=`https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
        const msg=`ğŸš¨ EMERGENCY ALERT!\nLocation: ${loc}`;
        emailjs.send("YOUR_SERVICE_ID","YOUR_TEMPLATE_ID",{message:msg});
        showToast("ğŸš¨ SOS sent!");
      });
    }

    // Weekly Chart
    function drawWeeklyChart(){
      const ctx=document.getElementById("weeklyChart").getContext("2d");
      const week=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      const data=week.map(()=>Math.floor(Math.random()*5));
      new Chart(ctx,{type:"bar",data:{labels:week,datasets:[{label:"Medicines Taken",data,backgroundColor:"#1976D2"}]},options:{responsive:true,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});
    }
  </script>
</body>
</html>
